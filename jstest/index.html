<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keys</title>
  </head>
  <body>
    <script>
      const keymap = {};

      function setKeyMapPair(key1, key2) {
        keymap[key1] = key2;
        keymap[key2] = key1;
        keymap[key1.toLowerCase()] = key2.toLowerCase();
        keymap[key2.toLowerCase()] = key1.toLowerCase();
      }

      setKeyMapPair("A", ";");
      setKeyMapPair("B", "B");
      setKeyMapPair("C", "M");
      setKeyMapPair("D", "K");
      setKeyMapPair("E", "O");
      setKeyMapPair("F", "J");
      setKeyMapPair("G", "H");
      setKeyMapPair("I", "R");
      setKeyMapPair("L", "S");
      setKeyMapPair("N", "V");
      setKeyMapPair("P", "W");
      setKeyMapPair("Q", "[");
      setKeyMapPair("T", "U");
      setKeyMapPair("X", ",");
      setKeyMapPair("Y", "Y");
      setKeyMapPair("Z", ".");

      keymap[":"] = "A";
      keymap["{"] = "Q";
      keymap["<"] = "X";
      keymap[">"] = "Z";

      function typeInTextarea(newText, el = document.activeElement) {
        const [start, end] = [el.selectionStart, el.selectionEnd];
        el.setRangeText(newText, start, end, "end");
      }
      function backspace(el = document.activeElement) {
        if (el.selectionStart > 0) {
          el.setRangeText("", el.selectionStart - 1, el.selectionStart, "end");
        }
      }

      let space = false;
      let usedSpace = false;
      function keyListener(event) {
        if (
          (event.key != " " && !(event.key in keymap)) ||
          event.ctrlKey ||
          event.altKey
        ) {
          return;
        }
        event.stopImmediatePropagation();
        event.stopPropagation();
        event.preventDefault();
        if (event.key == " ") {
          if (event.type == "keydown" && !space) {
            space = true;
            typeInTextarea(" ");
          } else if (event.type == "keyup") {
            space = false;
            usedSpace = false;
          }
        } else if (event.type == "keydown") {
          if (space) {
            if (!usedSpace) {
              usedSpace = true;
              backspace();
            }
            typeInTextarea(keymap[event.key]);
          } else {
            typeInTextarea(event.key);
          }
        }
        console.log(space);
      }
      window.addEventListener("keydown", keyListener, true);
      window.addEventListener("keyup", keyListener, true);
    </script>
    <input type="text" />
  </body>
</html>
